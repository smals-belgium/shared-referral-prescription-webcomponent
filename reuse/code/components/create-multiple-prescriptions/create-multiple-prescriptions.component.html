<div class="wrapper">
  <div class="patient">
    <div data-cy="patient-label">
      {{'common.patient' | translate}}
    </div>
    <div>
      <div data-cy="patient-name" [attr.translate]="'no'">{{patient.firstName}} {{patient.lastName}}</div>
      <div data-cy="patient-ssin" [attr.translate]="'no'">{{patient.ssin | formatSsin}}</div>
    </div>
  </div>

  @if(errorCard.show){
    <app-error-card
      [message]="errorCard.message | translate : errorCard.translationOptions"
      [error]="errorCard.errorResponse"
      [showRetry]="false"
    ></app-error-card>
  }

  <mat-accordion [hideToggle]="createPrescriptionForms.length === 1" togglePosition="before">
    @for(prescriptionForm of createPrescriptionForms; track trackByFn; let last = $last) {
      <mat-expansion-panel
        [expanded]="last"
      >
        <mat-expansion-panel-header
          [class.no-toggle]="createPrescriptionForms.length === 1"
          [tabIndex]="createPrescriptionForms.length === 1 ? -1 : 0"
        >
          <mat-panel-title
            [class.invalid]="prescriptionForm.submitted && (!prescriptionForm.elementGroup?.valid || prescriptionForm.status === 'ERROR')">
            <h3 data-cy="template-label">{{prescriptionForm.templateCode | templateName}}</h3>
          </mat-panel-title>
          <mat-panel-description>

            @if(prescriptionForm.status === LoadingStatus.SUCCESS) {
              <mat-icon color="accent">check_circle</mat-icon>
            } @else if (prescriptionForm.status === LoadingStatus.ERROR) {
              <mat-icon color="warn">error</mat-icon>
            }

            @if(prescriptionForm.templateCode | templateName; as template) {
              <ng-container>
                @if(prescriptionForm.status !== LoadingStatus.SUCCESS && createPrescriptionForms.length > 1) {
                  <button
                    mat-icon-button
                    (click)="$event.stopPropagation(); clickDeletePrescription.emit({form: prescriptionForm, templateName: template})"
                    [attr.aria-label]="'prescription.ariaLabel.delete' | translate"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                }
              </ng-container>
            }

          </mat-panel-description>
        </mat-expansion-panel-header>

        @if(modelState().state === LoadingStatus.ERROR) {
          <app-error-card
            [message]="'prescription.errors.failedToCreateModel' | translate"
            [error]="modelState().error"
          ></app-error-card>
        } @else if(modelState().state === LoadingStatus.SUCCESS) {
          <app-success-card
            [message]="'prescription.model.create.success' | translate:{name: modelState().success}"
          ></app-success-card>
        }  @else if(modelState().state === LoadingStatus.LOADING) {
          <app-overlay-spinner mode="inline"></app-overlay-spinner>
        }

        @if(prescriptionForm.formTemplateState$(); as formTemplateState) {
          <ng-container>
            <app-overlay-spinner *ifStatusLoading="formTemplateState" mode="inline"></app-overlay-spinner>
            <div *ifStatusError="formTemplateState">Failed to load prescription form template.</div>
            <nihdi-referral-prescription-form
              *ifStatusSuccess="formTemplateState"
              [lang]="lang"
              [readonly]="prescriptionForm.status === LoadingStatus.SUCCESS"
              [submitted]="!!prescriptionForm.submitted"
              [template]="formTemplateState.data!"
              (changeElementGroup)="setElementGroup(prescriptionForm, formTemplateState.data!, $any($event)?.detail)"
            ></nihdi-referral-prescription-form>

            @if(intent.toLowerCase() === 'order'){
              <button
                mat-raised-button
                color="accent"
                (click)="handleClick(prescriptionForm, formTemplateState.data)"
              >
                <mat-icon>save</mat-icon>
                {{'prescription.model.create.title' | translate}}
              </button>
            }

          </ng-container>
        }

      </mat-expansion-panel>
    }
  </mat-accordion>

  @if (intent.toLowerCase() === 'order') {
  <div class="actions">
    <div>
      <div class="spacer">&nbsp;</div>
      <div>
        <button (click)="clickAddPrescription.emit()" mat-raised-button data-cy="prescription-create-add">
          <mat-icon color="accent">add_box</mat-icon>
          {{'prescription.create.addPrescription' | translate}}
        </button>
      </div>
    </div>
  </div>
  }
  <div class="general-actions">
    <div>
      <div class="spacer">&nbsp;</div>
      <div>
        <button
          (click)="clickPublish.emit()"
          [disabled]="createPrescriptionForms.length === 0"
          color="accent"
          mat-raised-button
          data-cy="prescription-create-publish"
        >{{'prescription.create.publish' | translate}}
          @if(createPrescriptionForms.length > 1) {
            <ng-container>({{numberOfPrescriptionsToCreate}})</ng-container>
          }
        </button>
        <button
          (click)="clickCancel.emit()"
          mat-flat-button
          data-cy="prescription-create-cancel"
        >{{'common.cancel' | translate}}</button>
      </div>
    </div>
  </div>
</div>
